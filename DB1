Task 1 — PowerShell (resolve subscription ID)

Display name: Resolve subscription ID
Script Type: Inline

# Build the key: ADH_<adh_group>_<adh_subscription_type>_subscription_id
$adhGroup = "$(adh_group)"
$adhSubType = "$(adh_subscription_type)"   # prd | nonprd

if ([string]::IsNullOrWhiteSpace($adhGroup) -or [string]::IsNullOrWhiteSpace($adhSubType)) {
  throw "adh_group or adh_subscription_type is empty."
}

$key = "ADH_{0}_{1}_subscription_id" -f $adhGroup, $adhSubType
Write-Host "Looking up variable key: $key (linked variable groups)"

# Variable groups expose vars as environment variables
$subId = (Get-Item -Path "Env:$key" -ErrorAction SilentlyContinue).Value
if (-not $subId) {
  throw "No subscription ID found for '$key'. Check variable groups."
}

Write-Host "Resolved subscription: $subId"
Write-Host "##vso[task.setvariable variable=TargetSubId]$subId"

Task 2 — Azure CLI (PowerShell Core)

Display name: Delete Databricks Serverless Starter Warehouse(s)
Azure subscription: your fixed service connection
Script Type: PowerShell Core

# Inputs
$adhGroup    = "$(adh_group)"
$adhSubType  = "$(adh_subscription_type)"   # prd | nonprd
$targetSub   = "$(TargetSubId)"

if ([string]::IsNullOrWhiteSpace($adhGroup) -or [string]::IsNullOrWhiteSpace($adhSubType)) {
  throw "adh_group or adh_subscription_type is empty."
}
if ([string]::IsNullOrWhiteSpace($targetSub)) {
  throw "TargetSubId is empty (Task 1 must run first)."
}

# Pick environments: prd → ['prd']; nonprd → ['dev','tst','stg']
$envs = if ($adhSubType -eq "prd") { @("prd") } else { @("dev","tst","stg") }
Write-Host "Subscription type: $adhSubType; Environments to check: $($envs -join ', ')"

# Switch to the resolved subscription
az account set --subscription $targetSub

# Get AAD access token for Azure Databricks control plane (well-known app ID)
$token = az account get-access-token --resource 2ff814a6-3304-4ab8-85cb-cd0e6f879c1d --query accessToken -o tsv
if ([string]::IsNullOrWhiteSpace($token)) { throw "Failed to obtain AAD token for Databricks." }
$headers = @{ Authorization = "Bearer $token" }

# For each env, workspace name is ADH_<adh_group>_<env>; if workspace exists, delete the (Serverless) Starter Warehouse
foreach ($env in $envs) {
  $wsName = "ADH_{0}_{1}" -f $adhGroup, $env
  Write-Host "-----"
  Write-Host "Processing workspace: $wsName"

  # Find Databricks workspace resource in this subscription
  $ws = az resource list --resource-type Microsoft.Databricks/workspaces --query "[?name=='$wsName'] | [0]" -o json | ConvertFrom-Json

  if (-not $ws) {
    Write-Host "Workspace '$wsName' not found in subscription $targetSub. Skipping."
    continue
  }

  # Build control-plane host URL, e.g., https://adb-xxxxxxxxxxxx.y.azuredatabricks.net
  $host = "https://$($ws.properties.workspaceUrl)"
  Write-Host "Workspace host: $host"

  # List warehouses
  $listUri = "$host/api/2.0/sql/warehouses"
  try {
    $resp = Invoke-RestMethod -Method GET -Uri $listUri -Headers $headers -ErrorAction Stop
  } catch {
    Write-Warning "Failed to list warehouses for $wsName: $($_.Exception.Message)"
    continue
  }

  # Target names: prefer 'Serverless Starter Warehouse', fallback to 'Starter Warehouse'
  $primaryName  = "Serverless Starter Warehouse"
  $fallbackName = "Starter Warehouse"

  $starter = $resp.warehouses | Where-Object { $_.name -eq $primaryName } | Select-Object -First 1
  if (-not $starter) {
    Write-Host "'$primaryName' not found in $wsName; checking '$fallbackName'."
    $starter = $resp.warehouses | Where-Object { $_.name -eq $fallbackName } | Select-Object -First 1
  }

  if (-not $starter) {
    Write-Host "No Serverless/Starter Warehouse found in $wsName. Skipping."
    continue
  }

  # Delete it (idempotent; ignore 404)
  $delUri = "$host/api/2.0/sql/warehouses/$($starter.id)"
  Write-Host "Deleting warehouse '$($starter.name)' (id: $($starter.id)) in $wsName"
  try {
    Invoke-RestMethod -Method DELETE -Uri $delUri -Headers $headers -ErrorAction Stop | Out-Null
    Write-Host "Deleted '$($starter.name)' in $wsName."
  } catch {
    if ($_.Exception.Response -and $_.Exception.Response.StatusCode.value__ -eq 404) {
      Write-Host "'$($starter.name)' already deleted in $wsName (404)."
    } else {
      throw
    }
  }
}

Write-Host "-----"
Write-Host "Completed checks for environments: $($envs -join ', ')"

What changed vs your earlier setup

Variable name: subscription_type → adh_subscription_type

Envs handled:

adh_subscription_type=prd → operates only on ADH_<adh_group>_prd

adh_subscription_type=nonprd → iterates ADH_<adh_group>_dev, ADH_<adh_group>_tst, ADH_<adh_group>_stg and deletes in whichever exist

Subscription key: still ADH_<adh_group>_<adh_subscription_type>_subscription_id in your linked variable groups

That’s all you need—paste these two updated tasks into your existing stage.
