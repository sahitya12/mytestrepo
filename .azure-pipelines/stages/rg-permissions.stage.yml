parameters:
  adh_group: ''
  prodCsvPath: ''
  nonProdCsvPath: ''
  variableGroup: 'modernization_tfstate_backend_details'

stages:
- stage: RG_Permissions
  displayName: RG Permissions (${{ parameters.adh_group }})
  variables:
    outDir: '$(Build.ArtifactStagingDirectory)/rg-perms'
  jobs:
  - template: ../templates/job.powershell-with-az.yml
    parameters:
      variableGroup: ${{ parameters.variableGroup }}
      displayName: 'RG Permissions Scan'
      scriptPath: 'sanitychecks/scripts/Scan-RG-Permissions-ByCustodian.ps1'
      workingDir: '$(Build.SourcesDirectory)/sanitychecks/scripts'
      arguments: >
        -TenantId "$(tenant_id)"
        -ClientId "$(backend_client_id)"
        -ClientSecret "$(backend_client_secret)"
        -ProdCsvPath "${{ parameters.prodCsvPath }}"
        -NonProdCsvPath "${{ parameters.nonProdCsvPath }}"
        -adh_group "${{ parameters.adh_group }}"
        -OutputDir "$(outDir)"
        -TeamsWebhookUrl "$(teamsWebhook)"
      artifactName: "rg-perms-${{ parameters.adh_group }}"
      publishPath: "$(outDir)"
