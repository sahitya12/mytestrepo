#!/bin/bash

# Output file
output_file="adls_ip_whitelist_report.csv"

# Write CSV header
echo "Subscription Name,Subscription ID,Resource Group,Storage Account,IP Whitelist Count" > "$output_file"

# Get all subscriptions
az account list --query "[].{Name:name, Id:id}" -o tsv |
while IFS=$'\t' read -r subName subId; do
    az account set --subscription "$subId" --only-show-errors

    # Get all storage accounts where name contains 'adls'
    az storage account list \
        --query "[?contains(to_lower(name), 'adls')].{Name:name, ResourceGroup:resourceGroup}" \
        -o tsv |
    while IFS=$'\t' read -r saName rgName; do
        # Get count of IP rules
        ip_count=$(az storage account show \
            --name "$saName" \
            --resource-group "$rgName" \
            --query "length(networkRuleSet.ipRules)" \
            -o tsv 2>/dev/null)

        # Handle null
        if [ -z "$ip_count" ]; then ip_count=0; fi

        # Append to CSV
        echo "\"$subName\",\"$subId\",\"$rgName\",\"$saName\",$ip_count" >> "$output_file"
        echo "Checked: $subName / $saName -> $ip_count IP(s)"
    done
done

echo ""
echo "âœ… Report generated: $output_file"




adls_ip_whitelist_report.sh

chmod +x adls_ip_whitelist_report.sh

./adls_ip_whitelist_report.sh
